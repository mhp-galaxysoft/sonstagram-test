<%- include("../include/head") %>
<%- include("../include/mypage/mypage-css") %>
</head>
    <body>
        <%- include("../include/admin-header") %>
        <div class="user-body">
            <div class="user-mypage">
                <%- include("../include/mypage/mypage-profile") -%>
                <div class="admin-contents">
                    <div class="admin-contents-head">
                        <% if(pageType == 'creation'){ %>
                            <h2 class="admin-contents-h2" style="margin: 0;">상품 생성</h2>
                        <% } else if(pageType == 'modification'){ %>
                            <h2 class="admin-contents-h2" style="margin: 0;">상품 수정</h2>
                        <% } %>
                    </div>
                    <div class="admin-contents-body" style="padding: 0">
                        <div class="product-create-table">
                            <table class="table pd-ct-table">
                                <tbody>
                                    <tr>
                                        <th>상품 이름</th>
                                        <td>
                                            <input type="text" id="product-name" class="reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>상품 원가</th>
                                        <td>
                                            <input type="text" id="product-price" class="reg_exp" limitsize="11" reg_type="num">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>할인율(%)</th>
                                        <td>
                                            <input type="text" id="product-discount-rate" class="reg_exp" limitsize="11" reg_type="num" placeholder="%">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>최종 상품값</th>
                                        <td>
                                            <input type="text" id="product-discount-price" class="reg_exp" limitsize="11" reg_type="num" disabled>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>URL</th>
                                        <td>
                                            <input type="text" id="product-url" class="reg_exp" limitsize="500" reg_type="url">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>상품 이미지</th>
                                        <td>
                                            <input type="text" id="change-img-btn" placeholder="+ 이미지를 첨부하세요" readonly >
                                            <input type="file" id="product-file-btn" accept=".gif, .jpg, .png, .jpeg" style="display: none">
                                            <div style="display: flex">
                                                <div id="product-img" class="item-img">
                                                    <img src="/" id="product-detail-img">
                                                </div>
                                                <img id="img-delete-btn" src="/images/user-mypage/x-button.svg" alt="" >
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션 개수</th>
                                        <td>
                                            <select id="product-option-num" class="pd-optione">
                                                <option value="0">없음</option>
                                                <option value="1">1개</option>
                                                <option value="2">2개</option>
                                                <option value="3">3개</option>
                                                <option value="4">4개</option>
                                                <option value="5">5개</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="product-option-container">
                                    <tr>
                                        <th>옵션 제목(1)</th>
                                        <td>
                                            <input type="text" class="option-title reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션(1)</th>
                                        <td>
                                            <button type="button" class="option-add-btn">+ 옵션 제목 추가하기</button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="product-option-container">
                                    <tr>
                                        <th>옵션 제목(2)</th>
                                        <td>
                                            <input type="text" class="option-title reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션(2)</th>
                                        <td>
                                            <button type="button" class="option-add-btn">+ 옵션 제목 추가하기</button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="product-option-container">
                                    <tr>
                                        <th>옵션 제목(3)</th>
                                        <td>
                                            <input type="text" class="option-title reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션(3)</th>
                                        <td>
                                            <button type="button" class="option-add-btn">+ 옵션 제목 추가하기</button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="product-option-container">
                                    <tr>
                                        <th>옵션 제목(4)</th>
                                        <td>
                                            <input type="text" class="option-title reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션(4)</th>
                                        <td>
                                            <button type="button" class="option-add-btn">+ 옵션 제목 추가하기</button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="product-option-container">
                                    <tr>
                                        <th>옵션(5) 제목</th>
                                        <td>
                                            <input type="text" class="option-title reg_exp" limitsize="100" reg_type="string">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>옵션(5)</th>
                                        <td>
                                            <button type="button" class="option-add-btn">+ 옵션 제목 추가하기</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="admin-create-btn">
                                <button id="save-btn" class="create-btn" type="button">저장하기</button>
                                <a class="cancel-btn" href="/channel-admin/products/manage">취소</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <%- include("../include/common-footer") %>
</html>
<script src="/js/regexp.js"></script>
<script>
    //변경된 사진 미리보기
    const changeImgBtn = document.getElementById('change-img-btn')
    const productFileBtn = document.getElementById('product-file-btn')
    const imgResetBtn = document.getElementById('img-reset-btn')
    const productDetailImg = document.getElementById('product-detail-img')
    const imgDeleteBtn = document.getElementById('img-delete-btn')
    const productImg = document.getElementById('product-img')

    productImg.style.display = "none"
    imgDeleteBtn.style.display = "none"

    //사진 click
    changeImgBtn.addEventListener('click',function(e){
        e.preventDefault()
        productFileBtn.click()
    })

    //사진 바뀌었을 때
    function readURL(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader()
            reader.onload = function (e) {
                productDetailImg.setAttribute('src', e.target.result)
            }
            reader.readAsDataURL(input.files[0])
        }
    }
    productFileBtn.addEventListener('change',function(){
        if(!/\.(gif|jpg|jpeg|png)$/i.test(productFileBtn.files[0].name)){
            productFileBtn.value = ""
            productImg.style.display = "none"
            imgDeleteBtn.style.display = "none"
            alert('사진 형식의 파일만 가능합니다.')
            return false
        }
        readURL(this)
        productImg.style.display = "block"
        imgDeleteBtn.style.display = "block"
    })
    imgDeleteBtn.addEventListener('click',function(){
        productImg.style.display = "none"
        imgDeleteBtn.style.display = "none"
        productFileBtn.value = ""
    })
</script>
<script>
    const productName = document.getElementById('product-name')
    const productPrice = document.getElementById('product-price')
    const productDiscountRate = document.getElementById('product-discount-rate')
    const productDiscountPrice = document.getElementById('product-discount-price')
    const productUrl = document.getElementById('product-url')
    const productOptionNum = document.getElementById('product-option-num')
    const productOptionContainer = document.getElementsByClassName('product-option-container')
    const optionTitle = document.getElementsByClassName('option-title')
    const optionAddBtn = document.getElementsByClassName('option-add-btn')
    const optionBox = document.getElementsByClassName('option-box')

    const regString = RegExp(/[;|`\@$%&\\]/gi) //문자열
    const regNum = RegExp( /[^0-9]/gi) //숫자만

    //최종 상품값 만들기
    function updateProductDiscountPrice(){
        if(productDiscountRate.value > 100){
            alert("할인율은 최대 100% 입니다.")
            productDiscountRate.value = ""
            return false
        }

        const finalPrice  = Number(productPrice.value)*Number(100-productDiscountRate.value)/100
        productDiscountPrice.value = Math.floor(finalPrice) //1의 자릿수 반올림
    }
    productPrice.onkeyup = updateProductDiscountPrice
    productDiscountRate.onkeyup = updateProductDiscountPrice

    // 옵션 row 삭제하기
    function removeOption(option_pk, container){
        <% if(pageType === 'modification'){ %>
        if(option_pk) removedOptions.push(option_pk)
        <% } %>
        container.parentElement.removeChild(container)
    }

    //옵션 row 추가하기
    function  addOption(button, option_pk){
        const optionContainer = button.parentElement
        const optionBox = optionContainer.getElementsByClassName('option-box')
        if(optionBox.length < 50){
            button.parentElement.insertBefore(makeOption(option_pk),button)
        }else{
            alert("옵션은 최대 50개까지 추가할 수 있습니다.")
        }
    }

    // 옵션 input box 만들기
    function setOptionBox(){
        const optionNum = productOptionNum.options[productOptionNum.selectedIndex].value
        for(let i = 0; i < optionNum; i++){
            productOptionContainer[i].style.display = 'table-row-group'
        }
        for(let i = optionNum; i < 5; i++){
            const optionTitle = productOptionContainer[i].getElementsByClassName('option-title')

            optionTitle[0].value = ""
            const optionBox = productOptionContainer[i].getElementsByClassName('option-box')
            for(let j = optionBox.length - 1; j >= 0; j--){
                const option_pk = optionBox[j].getAttribute('option_pk')
                removeOption(option_pk, optionBox[j])
            }

            addOption(optionAddBtn[i])
            productOptionContainer[i].style.display = 'none'
        }
    }
    productOptionNum.onchange = setOptionBox

    for(let i = 0; i < optionAddBtn.length; i++){
        optionAddBtn[i].addEventListener('click', function(){
            addOption(optionAddBtn[i])
        })
    }

    // option 작성하는 input 만들기
    function makeOption(option_pk){

        const container = document.createElement('div')
        const optionName = document.createElement('input')
        const optionPrice = document.createElement('input')

        container.style.display = 'flex'
        container.className = "option-box"
        if(option_pk) container.setAttribute('option_pk',option_pk)

        optionName.classList.add("reg_exp","option-name")
        optionName.setAttribute('type','text')
        optionName.setAttribute('placeholder','옵션을 입력하세요.')

        optionPrice.classList.add("reg_exp","option-price")
        optionPrice.setAttribute('type','text')
        optionPrice.setAttribute('placeholder','옵션 요금')

        optionName.onkeyup = function(){
            if(regString.test(optionName.value)){
                alert("입력 불가능한 문자가 포함되었습니다.")
                optionName.value = optionName.value.replace(regString, '')
            }
            if(optionName.value.length > 100){
                alert("입력은 최대 100글자까지 가능합니다.")
                optionName.value = optionName.value.substr(0, 100)
            }
        }
        optionPrice.onkeyup = function(){
            if(regNum.test(optionPrice.value)){
                alert("입력 불가능한 문자가 포함되었습니다.")
                optionPrice.value = optionPrice.value.replace(regNum, '')
            }
            if(optionPrice.value.length > 10){
                alert("입력은 최대 10글자까지 가능합니다.")
                optionPrice.value = optionPrice.value.substr(0, 10)
            }
        }

        container.appendChild(optionName)
        container.appendChild(optionPrice)

        const optionRemoveBtn = document.createElement('img')
        optionRemoveBtn.className = 'option-remove-btn'
        optionRemoveBtn.src = "/images/user-mypage/x-button.svg"
        optionRemoveBtn.onclick = function(){
            removeOption(option_pk, container)
        }
        container.appendChild(optionRemoveBtn)

        return container
        // <div class="option-box">
        //     <input type="text" class="reg_exp option-name" limitsize="100" reg_type="string" placeholder="옵션을 입력하세요.">
        //     <input type="text" class="reg_exp option-price" limitsize="11" reg_type="num" placeholder="옵션 요금">
        // </div>
    }

</script>
<script>
    // 상품 등록
    function checkValues(){
        if(!productName.value){
            alert("상품 이름을 입력하세요.")
            productName.focus()
            return false
        }
        else if(!productPrice.value){
            alert("상품 원가를 입력하세요.")
            productPrice.focus()
            return false
        }
        else if(!productDiscountRate.value){
            alert("할인율을 입력하세요.")
            productDiscountRate.focus()
            return false
        }
        else if(!productUrl.value){
            alert("상품 판매 url을 입력하세요.")
            productUrl.focus()
            return false
        }
        else if(productImg.style.display === "none"){
            alert("상품 이미지를 등록해주세요.")
            return false
        }

        const optionNum = productOptionNum.options[productOptionNum.selectedIndex].value
        const optionSet = []
        for(let i = 0; i < optionNum; i++){
            const key = i + 1
            const optionTitle = productOptionContainer[i].getElementsByClassName('option-title')
            const optionBox = productOptionContainer[i].getElementsByClassName('option-box')

            if(optionTitle[0].value === ""){
                alert("옵션 제목을 입력하세요.")
                optionTitle[0].focus()
                return false
            }else{
                for(let j = 0; j < optionBox.length; j++){
                    const optionName = optionBox[j].getElementsByClassName('option-name')
                    const optionPrice = optionBox[j].getElementsByClassName('option-price')

                    if(regString.test(optionName[0].value)){
                        alert("입력 불가능한 문자가 포함되었습니다.")
                        optionName[0].value = optionName[0].value.replace(regString, '')
                        optionName[0].focus()
                        return false
                    }
                    if(regNum.test(optionPrice[0].value)){
                        alert("입력 불가능한 문자가 포함되었습니다.")
                        optionPrice[0].value = optionPrice[0].value.replace(regNum, '')
                        optionPrice[0].focus()
                        return false
                    }
                    if(optionName[0].value === ""){
                        alert("옵션을 입력하세요.")
                        optionName[0].focus()
                        return false
                    }else if(optionPrice[0].value === ""){
                        alert("옵션 요금을 입력하세요.")
                        optionPrice[0].focus()
                        return false
                    }else{
                        optionSet.push({
                            option_pk : optionBox[j].getAttribute('option_pk'),
                            option_title_idx : key,
                            option_title : optionTitle[0].value,
                            option_name : optionName[0].value,
                            option_price : optionPrice[0].value
                        })
                    }
                }
            }
        }
        // 모든 값이 입력되었으면 form 전송
        saveProductInfo(optionSet)
    }

    function saveProductInfo(option){
        saveBtn.disabled = true

        let product_url = productUrl.value.split('://')
        if(product_url[0] != 'http' && product_url[0] != 'https') {
            product_url = 'https://' + productUrl.value
        }else{
            product_url = productUrl.value
        }

        const product_info = {
            product_name : productName.value,
            product_price : productPrice.value,
            product_discount_rate : productDiscountRate.value,
            product_url : product_url
        }

        const formData = new FormData()
        const file = productFileBtn.files[0]

        formData.append('info', JSON.stringify(product_info))
        formData.append('option',JSON.stringify(option))
        formData.append('img', file)

        <% if(pageType === 'creation'){ %>
        axios.post('/product', formData, {
            headers: {
                "Content-Type": "multipart/form-data"
            }
        }).then( function(res){
            const state = res.data.state
            switch (state){
                case 'FAIL':
                    alert('서버에 이상이 생겼습니다.')
                    saveBtn.disabled = false
                    break
                case 'SUCCESS':
                    alert('상품 등록이 완료되었습니다.')
                    location.href="/channel-admin/products/manage"
                    break
            }
        }).catch(function(err){
            alert('서버에 이상이 생겼습니다.')
            console.error(err)
            saveBtn.disabled = false
        })
        <% }else if(pageType === 'modification'){ %>
        formData.append('remove', removedOptions)
        axios.put('/product/'+'<%= product.product_pk %>', formData, {
            headers: {
                "Content-Type": "multipart/form-data"
            }
        }).then( function(res){
            const state = res.data.state
            switch (state){
                case 'FAIL':
                    alert('서버에 이상이 생겼습니다.')
                    saveBtn.disabled = false
                    break
                case 'SUCCESS':
                    alert('상품 수정이 완료되었습니다.')
                    location.href = '/channel-admin/products/manage'
                    break
            }
        }).catch(function(err){
            alert('서버에 이상이 생겼습니다.')
            saveBtn.disabled = false
        })
        <% } %>
    }

    const saveBtn = document.getElementById('save-btn')
    saveBtn.addEventListener('click', checkValues)

</script>
<script>
    // 페이지 초기화
    <% if(pageType === 'creation'){ %>
    for(let i = 0; i < 5; i++){
        addOption(optionAddBtn[i])
    }
    <% } else if(pageType === 'modification'){ %>
    const removedOptions = []
    productName.value = '<%= product.product_name %>'
    productPrice.value = <%= product.product_price %>
    productDiscountRate.value = <%= product.product_discount_rate %>
    updateProductDiscountPrice()
    productUrl.value = '<%= product.product_url%>'
    productDetailImg.setAttribute('src', '<%= product.product_img %>')
    productImg.style.display = "block"
    imgDeleteBtn.style.display = "block"

    const optionNum = <%= product.option_title_idx %>
    const options = JSON.parse('<%- JSON.stringify(options) %>')
    $(productOptionNum).val(optionNum).prop('selected',true)
    for(let i = 0; i < optionNum; i++){
        productOptionContainer[i].style.display = 'table-row-group'
        const optionData = options[i+1]
        const optionTitle = productOptionContainer[i].getElementsByClassName('option-title')
        const optionAddBtn = productOptionContainer[i].getElementsByClassName('option-add-btn')

        optionTitle[0].value = optionData[0].option_title
        for(let i = 0; i < optionData.length; i++){
            addOption(optionAddBtn[0],optionData[i].option_pk)
        }

        const optionBox = productOptionContainer[i].getElementsByClassName('option-box')
        for(let i = 0; i < optionBox.length; i++){
            const optionName = optionBox[i].getElementsByClassName('option-name')
            const optionPrice = optionBox[i].getElementsByClassName('option-price')
            optionName[0].value = optionData[i].option_name
            optionPrice[0].value = optionData[i].option_price
            optionBox[i].setAttribute('option_pk', optionData[i].option_pk)
        }
    }
    for(let i = optionNum; i < 5; i++){
        addOption(optionAddBtn[i])
        productOptionContainer[i].style.display = 'none'
    }
    <% } %>
</script>
<style>
    .item-img{
        border: 1px solid #e5e5e5;
        padding-left: 7px;
        width: 70%;
    }

    #change-img-btn{
        background: white;
        cursor: pointer;
    }

    #item-detail-img{
        max-width: 90%;
    }

    #img-delete-btn{
        cursor: pointer;
        margin-left : 10px;
        width: 40px;
        height: 20px;
        margin-top: 7px;
    }
</style>


